<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luna - Asistente Musical</title>
    <meta name="theme-color" content="#1a0033">
    <meta name="description" content="Asistente musical con control por voz">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Luna%20Musical%22,%22short_name%22:%22Luna%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%231a0033%22,%22theme_color%22:%22%2300ffff%22,%22icons%22:[{%22src%22:%22https://img.icons8.com/fluency/512/music.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">
    <style>
        /* Todo el CSS moderno que ya tienes (el mismo del mensaje anterior) */
        body { margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a0033, #000033); color: #00ffff; font-family: Arial, sans-serif; padding: 10px; box-sizing: border-box; position: relative; }
        .container { background: rgba(0, 255, 255, 0.05); backdrop-filter: blur(25px); border-radius: 30px; padding: 25px; box-shadow: 0 20px 60px rgba(0, 255, 255, 0.3); width: 95%; max-width: 750px; height: 95vh; display: flex; flex-direction: column; align-items: center; position: relative; border: 1px solid #ff00ff; }
        h1 { font-size: clamp(2.2em, 9vw, 3em); margin: 15px 0 25px; text-shadow: 0 0 20px #ff00ff, 0 0 10px #00ffff; }
        /* ... pega aquí todo el resto del CSS que ya tienes (visualizer, waveLine, etc.) ... */
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>Luna - Asistente Musical</h1>
        <div id="startBtn" style="display:none;"><i class="fas fa-play-circle"></i></div>
        <div id="visualizer"></div>
        <div id="waveLine"><canvas id="waveCanvas"></canvas></div>
        <div id="voiceCircle"></div>
        <div id="micBtn"><i class="fas fa-microphone"></i></div>
        <div id="status">Cargando tu biblioteca guardada...</div>
        <div id="transcription">Escuchando tu comando...</div>
        <audio id="player" controls></audio>
        <div id="playlist"></div>
    </div>
    <div id="addMusicBtn" title="Agregar música"><i class="fas fa-folder-plus"></i></div>
    <input type="file" id="folderInput" webkitdirectory directory multiple accept="audio/*" style="display:none;">

    <script>
        // Elementos
        const player = document.getElementById('player');
        const folderInput = document.getElementById('folderInput');
        const addMusicBtn = document.getElementById('addMusicBtn');
        const playlistDiv = document.getElementById('playlist');
        const status = document.getElementById('status');
        const transcription = document.getElementById('transcription');
        const startBtn = document.getElementById('startBtn');
        const micBtn = document.getElementById('micBtn');
        const visualizer = document.getElementById('visualizer');
        const voiceCircle = document.getElementById('voiceCircle');
        const waveCanvas = document.getElementById('waveCanvas');
        const waveCtx = waveCanvas.getContext('2d');

        let songs = [];
        let current = -1;
        let unlocked = false;
        let audioContext, analyser, source, animationId, waveAnimationId;
        let esperandoComando = false;

        const NOMBRE_ASISTENTE = "luna";

        // IndexedDB para persistencia
        let db;
        const dbRequest = indexedDB.open('LunaSongsDB', 1);
        dbRequest.onupgradeneeded = (e) => {
            db = e.target.result;
            db.createObjectStore('songs', { keyPath: 'id', autoIncrement: true });
        };
        dbRequest.onsuccess = (e) => {
            db = e.target.result;
            loadSongsFromDB();
        };

        async function loadSongsFromDB() {
            const transaction = db.transaction('songs');
            const store = transaction.objectStore('songs');
            const request = store.getAll();

            request.onsuccess = () => {
                songs = request.result.map(s => ({ ...s, name: normalizar(s.fullName.replace(/\.[^/.]+$/, "")) }));
                renderPlaylist();
                if (songs.length > 0) {
                    status.innerHTML = `¡Bienvenido! Tienes ${songs.length} canciones guardadas<br>Di "Luna" para hablarme`;
                    startBtn.style.display = 'block';
                } else {
                    status.innerHTML = "Agrega música para comenzar<br>Toca el + abajo a la derecha";
                }
            };
        }

        function saveSongToDB(song) {
            const transaction = db.transaction('songs', 'readwrite');
            const store = transaction.objectStore('songs');
            store.add(song);
        }

        function renderPlaylist() {
            playlistDiv.innerHTML = '';
            songs.forEach((song, i) => {
                const div = document.createElement('div');
                div.className = 'song';
                div.textContent = song.fullName;
                div.onclick = () => reproducir(i);
                playlistDiv.appendChild(div);
            });
        }

        // Carga de música
        addMusicBtn.onclick = () => folderInput.click();
        folderInput.onchange = () => {
            const files = Array.from(folderInput.files);
            let nuevas = 0;
            files.forEach(file => {
                if (file.type.startsWith('audio/')) {
                    const url = URL.createObjectURL(file);
                    if (songs.some(s => s.fullName === file.name)) return;
                    const song = { fullName: file.name, url };
                    songs.push(song);
                    saveSongToDB(song);
                    nuevas++;
                }
            });
            renderPlaylist();
            status.innerHTML = nuevas > 0 ? `Agregué ${nuevas} canciones. Total: ${songs.length}` : "No se agregaron canciones";
            if (nuevas > 0 && songs.length === nuevas) startBtn.style.display = 'block';
        };

        // ... (pega aquí todo el código de visualizador, onda modular, reconocimiento de voz, reproducir, etc. del mensaje anterior)

        // Las canciones se guardan en IndexedDB y se quedan para siempre en esa URL
    </script>
</body>
</html>
